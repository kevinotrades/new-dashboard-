<html lang="en"><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap');
        body { font-family: 'Inter', sans-serif; }
        
        .view-section { transition: opacity 0.2s ease-in-out; }
        .fade-enter { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #cbd5e1; }
        
        /* Checkbox */
        .custom-checkbox input:checked + div { background-color: #2563eb; border-color: #2563eb; }
        .custom-checkbox input:checked + div svg { display: block; }

        /* Status Styles */
        .status-paid { background-color: #dcfce7; color: #15803d; border-color: #bbf7d0; }
        .status-pending { background-color: #fef9c3; color: #a16207; border-color: #fef08a; }
        .status-canceled { background-color: #fee2e2; color: #b91c1c; border-color: #fecaca; }
        
        /* Chat Bubble Animation */
        .chat-enter { animation: popIn 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        @keyframes popIn {
            from { opacity: 0; transform: scale(0.9) translateY(10px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-600 h-screen flex flex-col overflow-hidden antialiased selection:bg-blue-100 selection:text-blue-700">

    <!-- LOGIN REMOVED: LOADS INSTANTLY -->
    <!-- TOAST NOTIFICATION -->
    <div id="toast" class="fixed bottom-6 right-6 z-[150] translate-y-20 opacity-0 transition-all duration-300 bg-slate-900 text-white px-4 py-3 rounded-lg shadow-xl flex items-center gap-3 text-sm font-medium">
        <i data-lucide="check-circle" class="w-4 h-4 text-green-400"></i>
        <span id="toast-message">Operation successful</span>
    </div>

    <!-- Header -->
    <header class="h-16 border-b border-slate-200/60 flex items-center px-6 justify-between shrink-0 bg-white z-30 relative shadow-[0_1px_2px_rgba(0,0,0,0.02)]">
        <div class="flex items-center gap-10">
            <!-- Logo -->
            <div class="w-8 h-8 bg-blue-600 rounded-xl flex items-center justify-center text-white shrink-0 shadow-sm shadow-blue-200 cursor-pointer hover:bg-blue-700 transition-colors" onclick="switchMainView('clients')">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" class="transform -translate-y-px">
                    <path d="M12 3L3 10v10a1 1 0 001 1h16a1 1 0 001-1V10L12 3z" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"></path>
                </svg>
            </div>
            
            <!-- Main Nav -->
            <nav class="hidden md:flex items-center gap-8" id="main-nav">
                <button onclick="switchMainView('chat')" class="nav-item text-sm font-medium text-slate-400 hover:text-slate-900 transition-colors" data-target="chat">Messages</button>
                <button onclick="switchMainView('projects')" class="nav-item text-sm font-medium text-slate-400 hover:text-slate-900 transition-colors" data-target="projects">Projects</button>
                <button onclick="switchMainView('clients')" class="nav-item text-sm font-medium text-slate-900 transition-colors relative" data-target="clients">Clients</button>
                <button onclick="switchMainView('tasks')" class="nav-item text-sm font-medium text-slate-400 hover:text-slate-900 transition-colors" data-target="tasks">Tasks</button>
                <button onclick="switchMainView('invoices')" class="nav-item text-sm font-medium text-slate-400 hover:text-slate-900 transition-colors" data-target="invoices">Invoices</button>
            </nav>
        </div>

        <!-- Right Tools -->
        <div class="flex items-center gap-6">
            <div class="flex items-center gap-4 text-slate-400">
                <button class="hover:text-slate-600 transition-colors relative">
                    <i data-lucide="bell" class="w-5 h-5"></i>
                    <span class="absolute top-0 right-0 w-2 h-2 bg-red-500 rounded-full border-2 border-white"></span>
                </button>
                
                <!-- Profile Trigger -->
                <div class="flex items-center gap-3 cursor-pointer p-1 rounded-full hover:bg-slate-50 transition-colors pr-3" onclick="openModal('modal-settings')">
                    <div class="w-8 h-8 bg-slate-200 rounded-full overflow-hidden border border-slate-100 relative">
                        <img id="header-avatar" src="https://api.dicebear.com/7.x/avataaars/svg?seed=Felix" alt="User" class="w-full h-full object-cover">
                    </div>
                    <span id="header-username" class="text-xs font-medium text-slate-700 hidden sm:block">Felix User</span>
                </div>
            </div>
        </div>
    </header>

    <!-- VIEW: CHAT (Global) -->
    <main id="view-chat" class="view-section hidden flex-1 flex h-full overflow-hidden fade-enter bg-white">
        <!-- Chat Sidebar -->
        <aside class="w-80 border-r border-slate-200 bg-slate-50/50 flex flex-col shrink-0">
            <div class="p-4 border-b border-slate-100">
                <div class="relative">
                    <i data-lucide="search" class="absolute left-3 top-2.5 w-4 h-4 text-slate-400"></i>
                    <input type="text" placeholder="Search people &amp; projects..." class="w-full bg-white border border-slate-200 rounded-lg pl-9 pr-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-100 focus:border-blue-400 transition-all">
                </div>
            </div>
            <div class="flex-1 overflow-y-auto p-3 space-y-6">
                <!-- Projects Section -->
                <div>
                    <h3 class="px-3 text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-2">Projects</h3>
                    <div class="space-y-0.5" id="chat-sidebar-projects">
                        <!-- Populated by JS -->
                    </div>
                </div>
                
                <!-- Direct Messages Section -->
                <div>
                    <div class="flex items-center justify-between px-3 mb-2">
                        <h3 class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Direct Messages</h3>
                        <button onclick="openModal('modal-invite')" class="text-slate-400 hover:text-blue-600 transition-colors"><i data-lucide="plus" class="w-3.5 h-3.5"></i></button>
                    </div>
                    <div class="space-y-0.5" id="chat-sidebar-dms">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </div>
            <!-- User Status Footer -->
            <div class="p-4 border-t border-slate-200 bg-white flex items-center justify-between">
                <div class="flex items-center gap-2">
                    <div class="w-2 h-2 rounded-full bg-green-500 shadow-sm shadow-green-200"></div>
                    <span class="text-xs font-medium text-slate-600">Online</span>
                </div>
                <i data-lucide="settings" class="w-4 h-4 text-slate-400 cursor-pointer hover:text-slate-600"></i>
            </div>
        </aside>

        <!-- Chat Area -->
        <div class="flex-1 flex flex-col min-w-0 bg-white" id="global-chat-main">
            <!-- Chat Header -->
            <div class="h-16 border-b border-slate-100 flex items-center justify-between px-6 shrink-0 z-10 bg-white/80 backdrop-blur-sm">
                <div class="flex items-center gap-3">
                    <div id="active-chat-avatar" class="w-9 h-9 rounded-lg bg-slate-100 flex items-center justify-center text-slate-500 overflow-hidden">
                        #
                    </div>
                    <div>
                        <h2 id="active-chat-name" class="text-sm font-semibold text-slate-900">Select a conversation</h2>
                        <div class="flex items-center gap-1.5">
                             <div id="active-chat-status-dot" class="w-1.5 h-1.5 rounded-full bg-slate-300"></div>
                             <p id="active-chat-status" class="text-[10px] text-slate-400">Offline</p>
                        </div>
                    </div>
                </div>
                <button class="p-2 hover:bg-slate-50 rounded-lg text-slate-400 hover:text-slate-600 transition-colors">
                    <i data-lucide="more-horizontal" class="w-5 h-5"></i>
                </button>
            </div>

            <!-- Messages List -->
            <div class="flex-1 overflow-y-auto p-6 bg-slate-50/30" id="global-chat-container">
                <div class="h-full flex flex-col items-center justify-center text-slate-400 opacity-60">
                    <i data-lucide="message-square" class="w-12 h-12 mb-3 stroke-1"></i>
                    <p class="text-sm">Select a contact or project to start chatting</p>
                </div>
            </div>

            <!-- Input Area -->
            <div class="p-4 border-t border-slate-100 bg-white shrink-0 hidden" id="global-chat-input-area">
                <form onsubmit="sendGlobalMessage(event)" class="relative max-w-4xl mx-auto w-full">
                    <input type="text" id="global-chat-input" placeholder="Write a message..." class="w-full bg-slate-50 border border-slate-200 rounded-xl pl-4 pr-12 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-blue-100 focus:border-blue-400 transition-all shadow-sm" autocomplete="off">
                    <button type="submit" class="absolute right-2 top-1.5 bg-white p-1.5 rounded-lg text-blue-600 hover:bg-blue-50 transition-colors border border-transparent hover:border-blue-100">
                        <i data-lucide="send" class="w-4 h-4"></i>
                    </button>
                </form>
            </div>
        </div>
    </main>

    <!-- VIEW: CLIENTS -->
    <main id="view-clients" class="view-section flex-1 flex flex-col p-8 md:p-12 overflow-y-auto fade-enter bg-[#FAFBFC]">
        <div class="max-w-6xl mx-auto w-full">
            <div class="flex flex-col md:flex-row md:items-end justify-between mb-12 gap-6">
                <div>
                    <h1 class="text-3xl font-semibold text-slate-900 tracking-tight mb-2">Clients</h1>
                    <p class="text-slate-400 text-sm font-normal">Manage your client relationships, teams, and projects.</p>
                </div>
                <div class="flex items-center gap-4">
                    <button class="bg-blue-600 hover:bg-blue-700 text-white text-xs font-medium px-4 py-2 rounded shadow-sm shadow-blue-200 flex items-center gap-2 transition-all active:scale-95" onclick="openModal('modal-project')">
                        <i data-lucide="plus" class="w-3.5 h-3.5"></i>
                        New Project
                    </button>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="clients-grid">
                <!-- Card 1 -->
                <div onclick="openClientDetail('Ritual', 'Ritual Campaign Q4', 'Full stack marketing campaign for Q4 2023 focusing on conversion.')" class="group bg-white rounded-xl p-6 cursor-pointer border border-slate-100 shadow-[0_2px_10px_-4px_rgba(0,0,0,0.05)] hover:shadow-lg hover:-translate-y-1 transition-all duration-300 relative overflow-hidden">
                    <div class="absolute left-0 top-0 bottom-0 w-1 bg-blue-500"></div>
                    <div class="flex justify-between items-start mb-4">
                        <h3 class="text-lg font-semibold text-slate-900">Ritual</h3>
                        <div class="px-2 py-1 bg-green-50 text-green-600 rounded text-[10px] font-semibold border border-green-100">Active</div>
                    </div>
                    <p class="text-sm text-slate-400 leading-relaxed mb-8 line-clamp-2">Full stack marketing campaign for Q4 2023 focusing on conversion.</p>
                    <div class="flex items-center justify-between pt-4 border-t border-slate-50">
                        <!-- Avatar Stack -->
                        <div class="flex -space-x-2">
                            <div class="w-7 h-7 rounded-full border-2 border-white bg-gradient-to-br from-blue-400 to-indigo-500 flex items-center justify-center text-[9px] text-white font-bold">R</div>
                            <div class="w-7 h-7 rounded-full border-2 border-white bg-gradient-to-br from-purple-400 to-pink-500 flex items-center justify-center text-[9px] text-white font-bold">T</div>
                            <div class="w-7 h-7 rounded-full border-2 border-white bg-slate-100 flex items-center justify-center text-[9px] text-blue-600 font-bold">+3</div>
                        </div>
                        <span class="text-xs font-medium text-slate-400">2d ago</span>
                    </div>
                </div>
                
                 <!-- Card 2 -->
                 <div onclick="openClientDetail('Oura Ring', 'Oura Health Integration', 'API integration and dashboard visualization for user health data.')" class="group bg-white rounded-xl p-6 cursor-pointer border border-slate-100 shadow-[0_2px_10px_-4px_rgba(0,0,0,0.05)] hover:shadow-lg hover:-translate-y-1 transition-all duration-300 relative overflow-hidden">
                    <div class="absolute left-0 top-0 bottom-0 w-1 bg-teal-400"></div>
                    <div class="flex justify-between items-start mb-4">
                        <h3 class="text-lg font-semibold text-slate-900">Oura Ring</h3>
                        <div class="px-2 py-1 bg-green-50 text-green-600 rounded text-[10px] font-semibold border border-green-100">Active</div>
                    </div>
                    <p class="text-sm text-slate-400 leading-relaxed mb-8 line-clamp-2">API integration and dashboard visualization for user health data.</p>
                    <div class="flex items-center justify-between pt-4 border-t border-slate-50">
                        <!-- Avatar Stack -->
                        <div class="flex -space-x-2">
                            <div class="w-7 h-7 rounded-full border-2 border-white bg-gradient-to-br from-teal-400 to-emerald-500 flex items-center justify-center text-[9px] text-white font-bold">S</div>
                            <div class="w-7 h-7 rounded-full border-2 border-white bg-gradient-to-br from-orange-400 to-red-500 flex items-center justify-center text-[9px] text-white font-bold">M</div>
                        </div>
                        <span class="text-xs font-medium text-slate-400">1w ago</span>
                    </div>
                </div>

                <!-- Add New Button Card -->
                <button onclick="openModal('modal-project')" class="group border border-dashed border-slate-300 rounded-xl p-6 flex flex-col items-center justify-center gap-3 hover:border-blue-400 hover:bg-blue-50/50 transition-all h-full min-h-[200px]">
                    <div class="w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center group-hover:bg-blue-100 transition-colors">
                        <i data-lucide="plus" class="w-5 h-5 text-slate-400 group-hover:text-blue-600"></i>
                    </div>
                    <span class="text-sm font-medium text-slate-500 group-hover:text-blue-600">New Client</span>
                </button>
            </div>
        </div>
    </main>

    <!-- VIEW: CLIENT DETAIL -->
    <div id="view-client-detail" class="hidden flex-1 overflow-hidden flex h-full relative">
        <aside class="w-20 border-r border-slate-100 flex flex-col py-6 bg-white shrink-0 overflow-y-auto items-center z-10">
            <div class="mb-8 w-full px-2">
                <button onclick="switchMainView('clients')" class="w-full flex items-center justify-center gap-1 text-xs font-medium text-slate-500 hover:text-slate-900 transition-colors p-2 rounded-lg hover:bg-slate-50">
                    <i data-lucide="chevron-left" class="w-4 h-4"></i>
                    <span class="hidden sm:inline">Back</span>
                </button>
            </div>
            <div class="flex flex-col gap-6 w-full px-2">
                <button onclick="switchDetailTab('brief')" class="detail-nav-item active" data-tab="brief"><i data-lucide="file-text" class="w-5 h-5"></i><span class="text-[10px] font-medium">Brief</span></button>
                <button onclick="switchDetailTab('chat')" class="detail-nav-item" data-tab="chat"><i data-lucide="message-square" class="w-5 h-5"></i><span class="text-[10px] font-medium">Chat</span></button>
                <button onclick="switchDetailTab('media')" class="detail-nav-item" data-tab="media"><i data-lucide="image" class="w-5 h-5"></i><span class="text-[10px] font-medium">Media</span></button>
                <button onclick="switchDetailTab('tasks')" class="detail-nav-item" data-tab="tasks"><i data-lucide="check-square" class="w-5 h-5"></i><span class="text-[10px] font-medium">Tasks</span></button>
            </div>
        </aside>

        <main class="flex-1 flex flex-col bg-[#FAFBFC] min-w-0 relative h-full">
            <div class="h-16 flex items-center justify-between px-8 bg-white/80 border-b border-slate-100 shrink-0 backdrop-blur-sm sticky top-0 z-20">
                <div class="flex items-center gap-4">
                    <div id="client-color-indicator" class="w-2 h-2 rounded-full bg-blue-500"></div>
                    <div>
                        <h1 id="client-title-display" class="text-lg font-semibold tracking-tight text-slate-900 leading-tight">Ritual</h1>
                        <div class="flex items-center gap-2 mt-0.5" id="header-avatar-stack">
                            <!-- Injected by JS -->
                        </div>
                    </div>
                </div>
                <div class="flex items-center gap-3">
                    <button onclick="openModal('modal-invite')" class="flex items-center gap-2 px-3 py-1.5 text-xs font-medium text-blue-600 bg-blue-50 border border-blue-100 rounded shadow-sm hover:bg-blue-100 transition-all">
                        <i data-lucide="user-plus" class="w-3.5 h-3.5"></i>
                        Invite
                    </button>
                    <button onclick="openEditProjectModal()" class="group flex items-center gap-2 px-3 py-1.5 text-xs font-medium text-slate-500 bg-white border border-slate-200 rounded shadow-sm hover:bg-slate-50 hover:text-slate-900 transition-all">
                        <i data-lucide="pencil" class="w-3 h-3 text-slate-400 group-hover:text-slate-600"></i>
                        Edit Project
                    </button>
                </div>
            </div>

            <!-- Detail Content Area -->
            <div class="flex-1 overflow-hidden relative" id="detail-content-area">
                
                <!-- Brief Tab -->
                <div id="tab-brief" class="detail-tab-content fade-enter h-full overflow-y-auto p-8 md:p-10">
                    <div class="max-w-2xl bg-white rounded-xl border border-slate-100 shadow-sm p-8">
                        <h2 class="text-lg font-semibold text-slate-900 mb-6">Project Brief</h2>
                        <div class="space-y-6">
                            <div><label class="block text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1">Project Name</label><p id="brief-client-name" class="text-sm font-medium text-slate-800">Name</p></div>
                            <div><label class="block text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1">Description</label><p id="brief-client-desc" class="text-sm text-slate-600">Description text.</p></div>
                            
                            <div class="pt-6 border-t border-slate-50">
                                <label class="block text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-3">Team Members</label>
                                <div class="flex items-center gap-3">
                                    <div class="flex -space-x-2">
                                        <div class="w-8 h-8 rounded-full border-2 border-white bg-gradient-to-br from-blue-400 to-indigo-500 flex items-center justify-center text-[10px] text-white font-bold">R</div>
                                        <div class="w-8 h-8 rounded-full border-2 border-white bg-gradient-to-br from-purple-400 to-pink-500 flex items-center justify-center text-[10px] text-white font-bold">T</div>
                                        <div class="w-8 h-8 rounded-full border-2 border-white bg-slate-100 flex items-center justify-center text-[10px] text-blue-600 font-bold">+3</div>
                                    </div>
                                    <button onclick="openModal('modal-invite')" class="text-xs text-blue-600 font-medium hover:underline">Manage Team</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Chat Tab (In-Project) -->
                <div id="tab-chat" class="detail-tab-content hidden h-full flex flex-col">
                    <!-- Chat Messages Area -->
                    <div class="flex-1 overflow-y-auto p-6 bg-slate-50" id="chat-container">
                        <div class="flex flex-col space-y-4" id="chat-messages">
                            <!-- Messages will be injected here -->
                            <div class="text-center text-xs text-slate-300 py-4">Encryption active. Chat history is stored locally.</div>
                        </div>
                    </div>
                    <!-- Chat Input -->
                    <div class="p-4 bg-white border-t border-slate-200 shrink-0">
                        <form onsubmit="sendChatMessage(event)" class="max-w-4xl mx-auto flex gap-3">
                            <input type="text" id="chat-input" placeholder="Type a message to the client..." class="flex-1 bg-slate-50 border border-slate-200 rounded-lg px-4 py-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-blue-100 focus:border-blue-400 transition-all" autocomplete="off">
                            <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors flex items-center gap-2">
                                <i data-lucide="send" class="w-4 h-4"></i>
                            </button>
                        </form>
                    </div>
                </div>

                <!-- Media Tab -->
                <div id="tab-media" class="detail-tab-content hidden fade-enter h-full overflow-y-auto p-8 md:p-10">
                    <div class="max-w-4xl mx-auto">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-lg font-semibold text-slate-900">Project Assets</h2>
                            <button onclick="addMedia()" class="text-xs bg-white border border-slate-200 hover:border-blue-400 hover:text-blue-600 px-3 py-1.5 rounded-lg transition-colors flex items-center gap-2">
                                <i data-lucide="upload" class="w-3 h-3"></i> Upload File
                            </button>
                        </div>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4" id="media-grid">
                            <!-- Placeholder Image -->
                            <div class="group relative aspect-square bg-slate-100 rounded-xl overflow-hidden border border-slate-200">
                                <img src="https://images.unsplash.com/photo-1600607686527-6fb886090705?auto=format&amp;fit=crop&amp;q=80&amp;w=300&amp;h=300" class="w-full h-full object-cover opacity-80 group-hover:opacity-100 transition-opacity">
                                <button onclick="this.parentElement.remove()" class="absolute top-2 right-2 bg-white/90 p-1.5 rounded-md text-red-500 opacity-0 group-hover:opacity-100 transition-opacity hover:bg-white"><i data-lucide="trash-2" class="w-3.5 h-3.5"></i></button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Client Tasks Tab -->
                <div id="tab-tasks" class="detail-tab-content hidden fade-enter h-full overflow-y-auto p-8 md:p-10">
                    <div class="max-w-3xl mx-auto">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-lg font-semibold text-slate-900">Client Tasks</h2>
                        </div>
                        <div class="flex gap-2 mb-4">
                            <input type="text" id="client-task-input" placeholder="Add task for this client..." class="flex-1 bg-white border border-slate-200 rounded-lg px-4 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-100 focus:border-blue-400 shadow-sm" onkeypress="if(event.key === 'Enter') addClientTask()">
                            <button onclick="addClientTask()" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-blue-700">Add</button>
                        </div>
                        <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
                            <ul id="client-task-list" class="divide-y divide-slate-100">
                                <!-- Empty state or items will go here -->
                                <li class="p-8 text-center text-sm text-slate-400 italic" id="client-task-empty">No tasks specific to this client yet.</li>
                            </ul>
                        </div>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <!-- VIEW: TASKS (Main) -->
    <main id="view-tasks" class="view-section hidden flex-1 flex flex-col bg-[#FAFBFC] fade-enter">
        <div class="max-w-3xl mx-auto w-full p-8 md:p-12 flex flex-col h-full">
            <div class="flex items-center gap-3 mb-2">
                <h1 class="text-3xl font-semibold text-slate-900 tracking-tight">My Tasks</h1>
                <span class="bg-slate-100 text-slate-500 text-[10px] px-2 py-1 rounded-full border border-slate-200 font-medium">Private</span>
            </div>
            <p class="text-slate-400 text-sm mb-8">Manage your personal daily todos. Only visible to you.</p>

            <div class="flex gap-2 mb-6">
                <input type="text" id="new-task-input" placeholder="Add a new task..." class="flex-1 bg-white border border-slate-200 rounded-lg px-4 py-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-blue-100 focus:border-blue-400 shadow-sm transition-all" onkeypress="if(event.key === 'Enter') addTask()">
                <button onclick="addTask()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">Add</button>
            </div>

            <div class="flex-1 bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden flex flex-col">
                <ul id="task-list" class="divide-y divide-slate-100 overflow-y-auto flex-1 p-0 m-0">
                    <li class="group flex items-center gap-3 p-4 hover:bg-slate-50 transition-colors">
                        <label class="custom-checkbox relative flex items-center cursor-pointer">
                            <input type="checkbox" class="peer sr-only">
                            <div class="w-5 h-5 border-2 border-slate-300 rounded-md bg-white peer-checked:bg-blue-500 peer-checked:border-blue-500 transition-all flex items-center justify-center">
                                <svg class="w-3.5 h-3.5 text-white hidden pointer-events-none" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"></path></svg>
                            </div>
                        </label>
                        <span class="text-sm text-slate-700 flex-1 task-text">Review Q4 Analytics</span>
                        <div class="flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                            <button onclick="editTask(this)" class="p-1.5 text-slate-400 hover:text-blue-600 hover:bg-blue-50 rounded"><i data-lucide="pencil" class="w-3.5 h-3.5"></i></button>
                            <button onclick="this.closest('li').remove()" class="p-1.5 text-slate-400 hover:text-red-500 hover:bg-red-50 rounded"><i data-lucide="trash-2" class="w-3.5 h-3.5"></i></button>
                        </div>
                    </li>
                </ul>
            </div>
        </div>
    </main>

    <!-- VIEW: INVOICES -->
    <main id="view-invoices" class="view-section hidden flex-1 flex flex-col p-8 md:p-12 overflow-y-auto bg-[#FAFBFC] fade-enter">
        <div class="max-w-6xl mx-auto w-full">
            <div class="flex justify-between items-end mb-8">
                <div>
                    <h1 class="text-3xl font-semibold text-slate-900 tracking-tight mb-2">Invoices</h1>
                    <p class="text-slate-400 text-sm">Manage billing and payments.</p>
                </div>
                <button onclick="openModal('modal-invoice')" class="bg-slate-900 text-white px-4 py-2 rounded-lg text-xs font-medium hover:bg-slate-800 transition-all shadow-lg shadow-slate-200 flex items-center gap-2 active:scale-95">
                    <i data-lucide="plus" class="w-3.5 h-3.5"></i> Create Invoice
                </button>
            </div>
            
            <div class="bg-white border border-slate-200 rounded-xl shadow-sm overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-slate-50 border-b border-slate-200">
                            <tr>
                                <th class="px-6 py-3 text-xs font-semibold text-slate-500 uppercase">Invoice</th>
                                <th class="px-6 py-3 text-xs font-semibold text-slate-500 uppercase">Client</th>
                                <th class="px-6 py-3 text-xs font-semibold text-slate-500 uppercase">Date</th>
                                <th class="px-6 py-3 text-xs font-semibold text-slate-500 uppercase">Amount</th>
                                <th class="px-6 py-3 text-xs font-semibold text-slate-500 uppercase">Status</th>
                                <th class="px-6 py-3 text-xs font-semibold text-slate-500 uppercase text-right">Link</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-100" id="invoice-table-body">
                            <tr>
                                <td class="px-6 py-4 font-medium text-slate-900">#INV-001</td>
                                <td class="px-6 py-4 text-slate-600">Ritual</td>
                                <td class="px-6 py-4 text-slate-500 text-xs">Oct 24, 2023</td>
                                <td class="px-6 py-4 font-medium text-slate-900">$12,400.00</td>
                                <td class="px-6 py-4">
                                    <button onclick="toggleInvoiceStatus(this)" class="status-paid px-2 py-1 rounded-full text-[10px] border font-medium transition-all hover:opacity-80">Paid</button>
                                </td>
                                <td class="px-6 py-4 text-right">
                                    <a href="#" target="_blank" class="text-slate-400 hover:text-blue-600 inline-block p-1"><i data-lucide="external-link" class="w-4 h-4"></i></a>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <!-- VIEW: PROJECTS (Placeholder) -->
    <main id="view-projects" class="view-section hidden flex-1 flex items-center justify-center bg-slate-50"><div class="text-center text-slate-400">Projects Overview</div></main>

    <!-- MODALS -->

    <!-- Invite Modal -->
    <div id="modal-invite" class="hidden fixed inset-0 bg-slate-900/30 backdrop-blur-sm z-50 flex items-center justify-center opacity-0 transition-opacity duration-200">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm p-6 transform scale-95 transition-transform duration-200">
            <div class="mb-4 text-center">
                <div class="w-10 h-10 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center mx-auto mb-3">
                    <i data-lucide="mail" class="w-5 h-5"></i>
                </div>
                <h3 class="text-lg font-semibold text-slate-900">Invite &amp; Chat</h3>
                <p class="text-xs text-slate-500 mt-1">Send an email invitation. They will appear in your direct messages.</p>
            </div>
            <form onsubmit="handleInvite(event)" class="space-y-4">
                <div>
                    <label class="block text-xs font-medium text-slate-700 mb-1">Email Address</label>
                    <input type="email" id="invite-email" placeholder="colleague@company.com" required="" class="w-full border border-slate-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-blue-500">
                </div>
                <div class="flex justify-end gap-3 pt-2">
                    <button type="button" onclick="closeModal('modal-invite')" class="px-4 py-2 text-sm text-slate-500 hover:bg-slate-50 rounded-lg">Cancel</button>
                    <button type="submit" class="px-4 py-2 text-sm bg-blue-600 text-white rounded-lg hover:bg-blue-700 shadow-lg shadow-blue-200/50">Send Invite</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Create Invoice Modal -->
    <div id="modal-invoice" class="hidden fixed inset-0 bg-slate-900/30 backdrop-blur-sm z-50 flex items-center justify-center opacity-0 transition-opacity duration-200">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md p-6 transform scale-95 transition-transform duration-200">
            <h3 class="text-lg font-semibold text-slate-900 mb-4">Create Invoice</h3>
            <form onsubmit="handleCreateInvoice(event)" class="space-y-4">
                <div>
                    <label class="block text-xs font-medium text-slate-700 mb-1">Client Name</label>
                    <input type="text" id="inv-client" required="" class="w-full border border-slate-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-blue-500">
                </div>
                <div>
                    <label class="block text-xs font-medium text-slate-700 mb-1">Amount ($)</label>
                    <input type="number" id="inv-amount" required="" class="w-full border border-slate-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-blue-500">
                </div>
                <div>
                    <label class="block text-xs font-medium text-slate-700 mb-1">Invoice Link (Optional)</label>
                    <div class="relative">
                        <i data-lucide="link" class="w-4 h-4 absolute left-3 top-2.5 text-slate-400"></i>
                        <input type="url" id="inv-link" placeholder="https://" class="w-full border border-slate-200 rounded-lg pl-9 pr-3 py-2 text-sm focus:outline-none focus:border-blue-500 text-slate-600">
                    </div>
                </div>
                <div class="flex justify-end gap-3 pt-4">
                    <button type="button" onclick="closeModal('modal-invoice')" class="px-4 py-2 text-sm text-slate-500 hover:bg-slate-50 rounded-lg">Cancel</button>
                    <button type="submit" class="px-4 py-2 text-sm bg-slate-900 text-white rounded-lg hover:bg-slate-800">Create</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Create/Edit Project Modal -->
    <div id="modal-project" class="hidden fixed inset-0 bg-slate-900/30 backdrop-blur-sm z-50 flex items-center justify-center opacity-0 transition-opacity duration-200">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md p-6 transform scale-95 transition-transform duration-200">
            <h3 class="text-lg font-semibold text-slate-900 mb-4" id="project-modal-title">New Project</h3>
            <form onsubmit="handleSaveProject(event)" class="space-y-4">
                <input type="hidden" id="proj-mode" value="create"> 
                <div>
                    <label class="block text-xs font-medium text-slate-700 mb-1">Project Name</label>
                    <input type="text" id="proj-name" required="" class="w-full border border-slate-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-blue-500">
                </div>
                <div>
                    <label class="block text-xs font-medium text-slate-700 mb-1">Description</label>
                    <textarea id="proj-desc" rows="3" class="w-full border border-slate-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-blue-500"></textarea>
                </div>
                <div class="flex justify-end gap-3 pt-4">
                    <button type="button" onclick="closeModal('modal-project')" class="px-4 py-2 text-sm text-slate-500 hover:bg-slate-50 rounded-lg">Cancel</button>
                    <button type="submit" class="px-4 py-2 text-sm bg-blue-600 text-white rounded-lg hover:bg-blue-700">Save Project</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Settings/Profile Modal -->
    <div id="modal-settings" class="hidden fixed inset-0 bg-slate-900/30 backdrop-blur-sm z-50 flex items-center justify-center opacity-0 transition-opacity duration-200">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm p-6 transform scale-95 transition-transform duration-200">
            <h3 class="text-lg font-semibold text-slate-900 mb-6">Profile Settings</h3>
            <form onsubmit="handleUpdateProfile(event)" class="space-y-5">
                <div class="flex flex-col items-center mb-4 group">
                    <div class="w-24 h-24 bg-slate-200 rounded-full overflow-hidden border-4 border-white shadow-lg relative cursor-pointer" onclick="document.getElementById('profile-upload').click()">
                         <img id="setting-avatar" src="https://api.dicebear.com/7.x/avataaars/svg?seed=Felix" alt="User" class="w-full h-full object-cover">
                         <div class="absolute inset-0 bg-black/30 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                             <i data-lucide="camera" class="w-6 h-6 text-white"></i>
                         </div>
                    </div>
                    <input type="file" id="profile-upload" class="hidden" accept="image/*" onchange="handleProfileImage(this)">
                    <span class="text-xs text-blue-600 mt-2 font-medium cursor-pointer" onclick="document.getElementById('profile-upload').click()">Change Picture</span>
                </div>
                <div>
                    <label class="block text-xs font-medium text-slate-700 mb-1">Display Name</label>
                    <input type="text" id="setting-name" value="Felix User" class="w-full border border-slate-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-blue-500">
                </div>
                <div class="flex justify-end gap-3 pt-2">
                    <button type="button" onclick="closeModal('modal-settings')" class="px-4 py-2 text-sm text-slate-500 hover:bg-slate-50 rounded-lg">Cancel</button>
                    <button type="submit" class="px-4 py-2 text-sm bg-slate-900 text-white rounded-lg hover:bg-slate-800">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        lucide.createIcons();

        // --- TOAST NOTIFICATION ---
        function showToast(message) {
            const toast = document.getElementById('toast');
            document.getElementById('toast-message').innerText = message;
            toast.classList.remove('translate-y-20', 'opacity-0');
            setTimeout(() => {
                toast.classList.add('translate-y-20', 'opacity-0');
            }, 3000);
        }

        // --- LOGIN LOGIC ---
        function handleLogin(e) {
            e.preventDefault();
            const loginScreen = document.getElementById('login-screen');
            loginScreen.style.opacity = '0';
            loginScreen.style.transition = 'opacity 0.5s ease';
            setTimeout(() => {
                loginScreen.classList.add('hidden');
                switchMainView('clients'); // Load dashboard after login
            }, 500);
        }

        // --- VIEW MANAGEMENT ---
        const views = ['clients', 'projects', 'chat', 'tasks', 'invoices'];
        let activeClientName = "";

        function switchMainView(viewName) {
            views.forEach(v => document.getElementById(`view-${v}`).classList.add('hidden'));
            document.getElementById('view-client-detail').classList.add('hidden');
            const target = document.getElementById(`view-${viewName}`);
            if (target) {
                target.classList.remove('hidden');
                target.classList.remove('fade-enter');
                void target.offsetWidth; // trigger reflow
                target.classList.add('fade-enter');
            }
            updateNav(viewName);

            // Init Chat if switching to Chat
            if(viewName === 'chat') {
                renderChatSidebar();
            }
        }

        function updateNav(active) {
            document.querySelectorAll('.nav-item').forEach(btn => {
                if (btn.dataset.target === active) {
                    btn.classList.remove('text-slate-400');
                    btn.classList.add('text-slate-900');
                } else {
                    btn.classList.add('text-slate-400');
                    btn.classList.remove('text-slate-900');
                }
            });
        }

        function openClientDetail(name, briefName, desc) {
            activeClientName = name;
            document.getElementById('view-clients').classList.add('hidden');
            document.getElementById('view-client-detail').classList.remove('hidden');
            
            document.getElementById('client-title-display').innerText = name;
            document.getElementById('brief-client-name').innerText = briefName || name + " Project";
            document.getElementById('brief-client-desc').innerText = desc || "No description provided.";
            
            const colors = {'Ritual': 'bg-yellow-400', 'Oura Ring': 'bg-teal-400', 'HiSmile': 'bg-pink-400'};
            document.getElementById('client-color-indicator').className = `w-2 h-2 rounded-full ${colors[name] || 'bg-blue-500'}`;
            
            // Generate Avatar Stack for Header
            const initials = name.substring(0,2).toUpperCase();
            document.getElementById('header-avatar-stack').innerHTML = `
                <div class="flex -space-x-1">
                     <div class="w-5 h-5 rounded-full border border-white bg-slate-300 text-[8px] flex items-center justify-center text-slate-600 font-bold">ME</div>
                     <div class="w-5 h-5 rounded-full border border-white bg-blue-100 text-[8px] flex items-center justify-center text-blue-600 font-bold">${initials}</div>
                     <div class="w-5 h-5 rounded-full border border-white bg-slate-100 text-[8px] flex items-center justify-center text-slate-500 font-bold">+2</div>
                </div>
                <span class="text-[10px] text-slate-400">Team</span>
            `;

            initChat(name); // Init embedded chat
            switchDetailTab('brief');
        }

        function switchDetailTab(tab) {
            document.querySelectorAll('.detail-tab-content').forEach(el => el.classList.add('hidden'));
            document.getElementById(`tab-${tab}`).classList.remove('hidden');
            
            document.querySelectorAll('.detail-nav-item').forEach(btn => {
                const icon = btn.querySelector('i');
                if(btn.dataset.tab === tab) {
                    btn.className = 'detail-nav-item w-full flex flex-col items-center gap-1.5 p-2 rounded-xl text-blue-600 bg-blue-50/50 border border-blue-100/50';
                } else {
                    btn.className = 'detail-nav-item w-full flex flex-col items-center gap-1.5 p-2 rounded-xl text-slate-400 hover:text-slate-600 hover:bg-slate-50 border border-transparent transition-all';
                }
            });
            
            if(tab === 'chat') {
               const chatContainer = document.getElementById('chat-container');
               chatContainer.scrollTop = chatContainer.scrollHeight; 
            }
        }

        // --- GLOBAL CHAT DATA & LOGIC ---
        // Mock data structure for global chat
        const globalChats = [
            { id: 'proj-ritual', type: 'project', name: 'Ritual', status: 'active', avatar: 'R', color: 'bg-blue-600' },
            { id: 'proj-oura', type: 'project', name: 'Oura Ring', status: 'active', avatar: 'O', color: 'bg-teal-500' },
            { id: 'dm-alice', type: 'dm', name: 'Alice Designer', status: 'online', avatar: 'https://api.dicebear.com/7.x/avataaars/svg?seed=Alice', lastMsg: 'Sent the assets.' },
            { id: 'dm-bob', type: 'dm', name: 'Bob Developer', status: 'offline', avatar: 'https://api.dicebear.com/7.x/avataaars/svg?seed=Bob', lastMsg: 'Can we sync?' }
        ];

        let activeChatId = null;

        function renderChatSidebar() {
            const projectsContainer = document.getElementById('chat-sidebar-projects');
            const dmsContainer = document.getElementById('chat-sidebar-dms');
            
            projectsContainer.innerHTML = '';
            dmsContainer.innerHTML = '';

            globalChats.forEach(chat => {
                const isActive = activeChatId === chat.id ? 'bg-slate-200/60 shadow-sm' : 'hover:bg-slate-100 cursor-pointer';
                const el = document.createElement('div');
                el.className = `flex items-center gap-3 p-2 rounded-lg transition-colors ${isActive}`;
                el.onclick = () => selectGlobalChat(chat.id);
                
                if(chat.type === 'project') {
                    el.innerHTML = `
                        <div class="w-8 h-8 rounded-lg ${chat.color} flex items-center justify-center text-white text-xs font-bold shadow-sm shrink-0">${chat.avatar}</div>
                        <div class="flex-1 min-w-0">
                            <div class="text-sm font-medium text-slate-700 truncate"># ${chat.name}</div>
                        </div>
                    `;
                    projectsContainer.appendChild(el);
                } else {
                    const statusColor = chat.status === 'online' ? 'bg-green-500' : 'bg-slate-300';
                    el.innerHTML = `
                        <div class="relative shrink-0">
                            <img src="https://hoirqrkdgbmvpwutwuwj.supabase.co/storage/v1/object/public/assets/assets/917d6f93-fb36-439a-8c48-884b67b35381_1600w.jpg" class="w-8 h-8 rounded-full bg-slate-200 object-cover">
                            <div class="absolute bottom-0 right-0 w-2.5 h-2.5 ${statusColor} border-2 border-white rounded-full"></div>
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="text-sm font-medium text-slate-700 truncate">${chat.name}</div>
                            <div class="text-[10px] text-slate-400 truncate">${chat.lastMsg || 'Start chatting'}</div>
                        </div>
                    `;
                    dmsContainer.appendChild(el);
                }
            });
        }

        function selectGlobalChat(id) {
            activeChatId = id;
            renderChatSidebar(); // Re-render to highlight active
            
            const chat = globalChats.find(c => c.id === id);
            if(!chat) return;

            // Update Header
            document.getElementById('active-chat-name').innerText = chat.type === 'project' ? '# ' + chat.name : chat.name;
            document.getElementById('active-chat-status').innerText = chat.status === 'online' ? 'Online' : (chat.type === 'project' ? 'Project Channel' : 'Offline');
            
            const statusDot = document.getElementById('active-chat-status-dot');
            statusDot.className = `w-1.5 h-1.5 rounded-full ${chat.status === 'online' ? 'bg-green-500' : 'bg-slate-300'}`;
            
            const avatarContainer = document.getElementById('active-chat-avatar');
            if(chat.type === 'project') {
                avatarContainer.className = `w-9 h-9 rounded-lg ${chat.color} flex items-center justify-center text-white font-bold`;
                avatarContainer.innerHTML = chat.avatar;
            } else {
                avatarContainer.className = "w-9 h-9 rounded-lg overflow-hidden";
                avatarContainer.innerHTML = `<img src="https://hoirqrkdgbmvpwutwuwj.supabase.co/storage/v1/object/public/assets/assets/917d6f93-fb36-439a-8c48-884b67b35381_1600w.jpg" class="w-full h-full object-cover">`;
            }

            // Show Input
            document.getElementById('global-chat-input-area').classList.remove('hidden');

            // Render Messages (Simulated)
            const msgContainer = document.getElementById('global-chat-container');
            msgContainer.innerHTML = '';
            
            // Fake history
            const history = chatStore[chat.name] || [
                { type: 'them', text: `This is the beginning of your conversation with ${chat.name}.`, time: 'Earlier' }
            ];
            
            history.forEach(msg => {
                const div = document.createElement('div');
                if(msg.type === 'me') {
                    div.className = "flex justify-end mb-4 chat-enter";
                    div.innerHTML = `
                        <div class="max-w-[75%]">
                            <div class="bg-blue-600 text-white text-sm px-4 py-2.5 rounded-2xl rounded-tr-sm shadow-sm">${msg.text}</div>
                            <div class="text-[10px] text-slate-400 text-right mt-1 mr-1">${msg.time}</div>
                        </div>
                    `;
                } else {
                    div.className = "flex justify-start mb-4 chat-enter";
                    div.innerHTML = `
                        <div class="flex items-end gap-2 max-w-[75%]">
                             ${chat.type === 'dm' ? `<img src="https://hoirqrkdgbmvpwutwuwj.supabase.co/storage/v1/object/public/assets/assets/917d6f93-fb36-439a-8c48-884b67b35381_1600w.jpg" class="w-6 h-6 rounded-full bg-slate-200 mb-1">` : ''}
                            <div>
                                <div class="bg-white border border-slate-200 text-slate-700 text-sm px-4 py-2.5 rounded-2xl rounded-tl-sm shadow-sm">${msg.text}</div>
                                <div class="text-[10px] text-slate-400 mt-1 ml-1">${msg.time}</div>
                            </div>
                        </div>
                    `;
                }
                msgContainer.appendChild(div);
            });
            msgContainer.scrollTop = msgContainer.scrollHeight;
        }

        function sendGlobalMessage(e) {
            e.preventDefault();
            const input = document.getElementById('global-chat-input');
            const text = input.value.trim();
            if(!text || !activeChatId) return;

            const chat = globalChats.find(c => c.id === activeChatId);
            const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            // Add to store
            if(!chatStore[chat.name]) chatStore[chat.name] = [];
            chatStore[chat.name].push({ type: 'me', text, time });

            // UI Append
            const msgContainer = document.getElementById('global-chat-container');
            const div = document.createElement('div');
            div.className = "flex justify-end mb-4 chat-enter";
            div.innerHTML = `
                <div class="max-w-[75%]">
                    <div class="bg-blue-600 text-white text-sm px-4 py-2.5 rounded-2xl rounded-tr-sm shadow-sm">${text}</div>
                    <div class="text-[10px] text-slate-400 text-right mt-1 mr-1">${time}</div>
                </div>
            `;
            msgContainer.appendChild(div);
            msgContainer.scrollTop = msgContainer.scrollHeight;
            input.value = '';

            // Update sidebar preview
            chat.lastMsg = "You: " + text;
            renderChatSidebar();
        }

        // --- CLIENT CHAT (Legacy embedded in Project) ---
        // Simulating data store for chat
        const chatStore = {}; 
        
        function initChat(clientName) {
            const chatBox = document.getElementById('chat-messages');
            chatBox.innerHTML = '<div class="text-center text-xs text-slate-300 py-4">Encryption active. Chat history is stored locally.</div>';
            
            if(!chatStore[clientName]) {
                chatStore[clientName] = [
                    { type: 'them', text: `Hi! Welcome to the ${clientName} project channel.`, time: '10:00 AM' },
                    { type: 'me', text: 'Thanks! Excited to get started.', time: '10:05 AM' }
                ];
            }
            
            chatStore[clientName].forEach(msg => renderMessage(msg));
        }

        function renderMessage(msg) {
            const chatBox = document.getElementById('chat-messages');
            const div = document.createElement('div');
            
            if(msg.type === 'me') {
                div.className = "flex justify-end chat-enter";
                div.innerHTML = `
                    <div class="max-w-[80%]">
                        <div class="bg-blue-600 text-white text-sm px-4 py-2 rounded-2xl rounded-tr-sm shadow-sm">
                            ${msg.text}
                        </div>
                        <div class="text-[10px] text-slate-400 text-right mt-1 mr-1">${msg.time}</div>
                    </div>
                `;
            } else {
                div.className = "flex justify-start chat-enter";
                div.innerHTML = `
                    <div class="flex items-end gap-2 max-w-[80%]">
                        <div class="w-6 h-6 rounded-full bg-slate-200 flex items-center justify-center text-[9px] font-bold text-slate-500 shrink-0">CL</div>
                        <div>
                            <div class="bg-white border border-slate-200 text-slate-700 text-sm px-4 py-2 rounded-2xl rounded-tl-sm shadow-sm">
                                ${msg.text}
                            </div>
                            <div class="text-[10px] text-slate-400 mt-1 ml-1">${msg.time}</div>
                        </div>
                    </div>
                `;
            }
            chatBox.appendChild(div);
            document.getElementById('chat-container').scrollTop = document.getElementById('chat-container').scrollHeight;
        }

        function sendChatMessage(e) {
            e.preventDefault();
            const input = document.getElementById('chat-input');
            const text = input.value.trim();
            if(!text) return;
            
            const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            const msg = { type: 'me', text: text, time: time };
            
            // Save & Render
            if(!chatStore[activeClientName]) chatStore[activeClientName] = [];
            chatStore[activeClientName].push(msg);
            renderMessage(msg);
            input.value = '';

            // Simulate Reply
            setTimeout(() => {
                const reply = { type: 'them', text: "Thanks for the update. I'll check it shortly.", time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) };
                chatStore[activeClientName].push(reply);
                renderMessage(reply);
            }, 1500);
        }

        // --- INVITE LOGIC ---
        function handleInvite(e) {
            e.preventDefault();
            const email = document.getElementById('invite-email').value;
            closeModal('modal-invite');
            document.getElementById('invite-email').value = '';
            
            // Logic: Add to DM list
            const id = 'dm-' + Math.random().toString(36).substr(2, 9);
            const name = email.split('@')[0];
            const newChat = { 
                id: id, 
                type: 'dm', 
                name: name + " (Invited)", 
                status: 'offline', 
                avatar: `https://api.dicebear.com/7.x/avataaars/svg?seed=${name}`,
                lastMsg: 'Invitation sent.'
            };
            
            globalChats.push(newChat);
            if(document.getElementById('view-chat').classList.contains('hidden') === false) {
                renderChatSidebar();
            }

            // Simulate processing
            setTimeout(() => {
                showToast(`Invitation sent to ${email}`);
                const stack = document.getElementById('header-avatar-stack');
                if(stack) {
                    const stackDiv = stack.querySelector('div');
                    if(stackDiv) {
                        const pending = document.createElement('div');
                        pending.className = "w-5 h-5 rounded-full border border-white bg-yellow-100 text-[8px] flex items-center justify-center text-yellow-600 font-bold chat-enter";
                        pending.title = "Pending: " + email;
                        pending.innerText = "?";
                        stackDiv.appendChild(pending);
                    }
                }
            }, 500);
        }

        // --- MODAL LOGIC ---
        function openModal(id) {
            const m = document.getElementById(id);
            m.classList.remove('hidden');
            setTimeout(() => {
                m.classList.remove('opacity-0');
                m.querySelector('div').classList.remove('scale-95');
                m.querySelector('div').classList.add('scale-100');
            }, 10);
        }

        function closeModal(id) {
            const m = document.getElementById(id);
            m.classList.add('opacity-0');
            m.querySelector('div').classList.remove('scale-100');
            m.querySelector('div').classList.add('scale-95');
            setTimeout(() => m.classList.add('hidden'), 200);
        }

        // --- TASKS (MAIN) LOGIC ---
        function addTask() {
            const input = document.getElementById('new-task-input');
            const text = input.value.trim();
            if (!text) return;
            
            const li = createTaskHTML(text);
            document.getElementById('task-list').prepend(li);
            input.value = '';
            lucide.createIcons();
        }

        function createTaskHTML(text) {
            const li = document.createElement('li');
            li.className = "group flex items-center gap-3 p-4 hover:bg-slate-50 transition-colors border-b border-slate-100 last:border-0";
            li.innerHTML = `
                <label class="custom-checkbox relative flex items-center cursor-pointer">
                    <input type="checkbox" class="peer sr-only">
                    <div class="w-5 h-5 border-2 border-slate-300 rounded-md bg-white peer-checked:bg-blue-500 peer-checked:border-blue-500 transition-all flex items-center justify-center">
                        <svg class="w-3.5 h-3.5 text-white hidden pointer-events-none" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" /></svg>
                    </div>
                </label>
                <span class="text-sm text-slate-700 flex-1 task-text">${text}</span>
                <div class="flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                    <button onclick="editTask(this)" class="p-1.5 text-slate-400 hover:text-blue-600 hover:bg-blue-50 rounded"><i data-lucide="pencil" class="w-3.5 h-3.5"></i></button>
                    <button onclick="this.closest('li').remove()" class="p-1.5 text-slate-400 hover:text-red-500 hover:bg-red-50 rounded"><i data-lucide="trash-2" class="w-3.5 h-3.5"></i></button>
                </div>
            `;
            return li;
        }

        function editTask(btn) {
            const li = btn.closest('li');
            const span = li.querySelector('.task-text');
            const currentText = span.innerText;
            
            const input = document.createElement('input');
            input.type = 'text';
            input.value = currentText;
            input.className = "flex-1 border border-blue-300 rounded px-2 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-blue-100";
            
            input.onblur = function() {
                span.innerText = this.value;
                li.replaceChild(span, this);
            };
            input.onkeypress = function(e) {
                if(e.key === 'Enter') this.blur();
            };

            li.replaceChild(input, span);
            input.focus();
        }

        // --- CLIENT DETAILS LOGIC (MEDIA & TASKS) ---
        function addMedia() {
            // Simulator for adding media
            const grid = document.getElementById('media-grid');
            const div = document.createElement('div');
            div.className = "group relative aspect-square bg-slate-50 rounded-xl overflow-hidden border border-slate-200 animate-pulse";
            // Simulate upload delay
            grid.appendChild(div);
            setTimeout(() => {
                div.classList.remove('animate-pulse');
                div.innerHTML = `
                    <img src="https://images.unsplash.com/photo-1618005182384-a83a8bd57fbe?auto=format&fit=crop&q=80&w=300&h=300" class="w-full h-full object-cover opacity-80 group-hover:opacity-100 transition-opacity">
                    <button onclick="this.parentElement.remove()" class="absolute top-2 right-2 bg-white/90 p-1.5 rounded-md text-red-500 opacity-0 group-hover:opacity-100 transition-opacity hover:bg-white"><i data-lucide="trash-2" class="w-3.5 h-3.5"></i></button>
                `;
                lucide.createIcons();
            }, 600);
        }

        function addClientTask() {
            const input = document.getElementById('client-task-input');
            const text = input.value.trim();
            if (!text) return;
            
            const list = document.getElementById('client-task-list');
            const emptyMsg = document.getElementById('client-task-empty');
            if (emptyMsg) emptyMsg.remove();

            const li = createTaskHTML(text); // Reuse the main task HTML generator
            list.prepend(li);
            input.value = '';
            lucide.createIcons();
        }

        // --- INVOICE LOGIC ---
        const invoiceStatuses = [
            { label: 'Paid', class: 'status-paid' },
            { label: 'Pending', class: 'status-pending' },
            { label: 'Canceled', class: 'status-canceled' }
        ];

        function handleCreateInvoice(e) {
            e.preventDefault();
            const client = document.getElementById('inv-client').value;
            const amount = document.getElementById('inv-amount').value;
            const link = document.getElementById('inv-link').value;
            const date = new Date().toLocaleDateString('en-US', {month:'short', day:'numeric', year:'numeric'});
            const id = "#INV-" + Math.floor(Math.random() * 1000);
            
            const tr = document.createElement('tr');
            tr.className = "hover:bg-slate-50/80 transition-colors";
            
            const linkHtml = link ? 
                `<a href="${link}" target="_blank" class="text-slate-400 hover:text-blue-600 inline-block p-1"><i data-lucide="external-link" class="w-4 h-4"></i></a>` : 
                `<span class="text-slate-200 cursor-not-allowed p-1"><i data-lucide="external-link" class="w-4 h-4"></i></span>`;

            tr.innerHTML = `
                <td class="px-6 py-4 font-medium text-slate-900">${id}</td>
                <td class="px-6 py-4 text-slate-600">${client}</td>
                <td class="px-6 py-4 text-slate-500 text-xs">${date}</td>
                <td class="px-6 py-4 font-medium text-slate-900">$${amount}</td>
                <td class="px-6 py-4"><button onclick="toggleInvoiceStatus(this)" class="status-pending px-2 py-1 rounded-full text-[10px] border font-medium transition-all hover:opacity-80">Pending</button></td>
                <td class="px-6 py-4 text-right">${linkHtml}</td>
            `;
            document.getElementById('invoice-table-body').prepend(tr);
            closeModal('modal-invoice');
            e.target.reset();
            lucide.createIcons();
            showToast("Invoice created successfully");
        }

        function toggleInvoiceStatus(btn) {
            let currentIdx = invoiceStatuses.findIndex(s => btn.classList.contains(s.class));
            // Remove current class
            if (currentIdx !== -1) btn.classList.remove(invoiceStatuses[currentIdx].class);
            
            // Next status
            const nextIdx = (currentIdx + 1) % invoiceStatuses.length;
            const nextStatus = invoiceStatuses[nextIdx];
            
            btn.innerText = nextStatus.label;
            btn.classList.add(nextStatus.class);
        }

        // --- PROFILE & PROJECT LOGIC ---
        function handleProfileImage(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('setting-avatar').src = e.target.result;
                    document.getElementById('header-avatar').src = e.target.result;
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        function handleUpdateProfile(e) {
            e.preventDefault();
            const newName = document.getElementById('setting-name').value;
            document.getElementById('header-username').innerText = newName;
            closeModal('modal-settings');
            showToast("Profile updated");
        }

        function handleSaveProject(e) {
            e.preventDefault();
            const name = document.getElementById('proj-name').value;
            const desc = document.getElementById('proj-desc').value;
            const mode = document.getElementById('proj-mode').value;

            if (mode === 'create') {
                const div = document.createElement('div');
                div.className = "group bg-white rounded-xl p-6 cursor-pointer border border-slate-100 shadow-[0_2px_10px_-4px_rgba(0,0,0,0.05)] hover:shadow-lg hover:-translate-y-1 transition-all duration-300 relative overflow-hidden";
                div.onclick = function() { openClientDetail(name, name, desc); };
                // Using random initials for the new project avatar stack simulation
                const i1 = name.charAt(0);
                const i2 = name.charAt(1) || 'X';
                
                div.innerHTML = `
                    <div class="absolute left-0 top-0 bottom-0 w-1 bg-blue-500"></div>
                    <div class="flex justify-between items-start mb-4"><h3 class="text-lg font-semibold text-slate-900">${name}</h3><div class="px-2 py-1 bg-green-50 text-green-600 rounded text-[10px] font-semibold border border-green-100">Active</div></div>
                    <p class="text-sm text-slate-400 leading-relaxed mb-8 line-clamp-2">${desc}</p>
                    <div class="flex items-center justify-between pt-4 border-t border-slate-50">
                        <div class="flex -space-x-2">
                             <div class="w-7 h-7 rounded-full border-2 border-white bg-gradient-to-br from-blue-400 to-indigo-500 flex items-center justify-center text-[9px] text-white font-bold">${i1}</div>
                             <div class="w-7 h-7 rounded-full border-2 border-white bg-slate-100 flex items-center justify-center text-[9px] text-blue-600 font-bold">+1</div>
                        </div>
                        <span class="text-xs font-medium text-slate-400">Just now</span>
                    </div>
                `;
                const grid = document.getElementById('clients-grid');
                // Insert before the "Add New" button (which is the last element)
                grid.insertBefore(div, grid.lastElementChild);
                showToast("Project created");
            } else {
                document.getElementById('client-title-display').innerText = name;
                document.getElementById('brief-client-name').innerText = name;
                document.getElementById('brief-client-desc').innerText = desc;
                showToast("Project updated");
            }
            closeModal('modal-project');
            document.getElementById('proj-name').value = '';
            document.getElementById('proj-desc').value = '';
        }

        function openEditProjectModal() {
            document.getElementById('project-modal-title').innerText = "Edit Project";
            document.getElementById('proj-mode').value = "edit";
            document.getElementById('proj-name').value = document.getElementById('brief-client-name').innerText;
            document.getElementById('proj-desc').value = document.getElementById('brief-client-desc').innerText;
            openModal('modal-project');
        }
    </script>


<!-- LOCALSTORAGE PERSISTENCE (ADDED) -->
<script>
(function(){
    // Central Store helper
    const Store = {
        load(key, fallback){
            try { return JSON.parse(localStorage.getItem(key)) ?? fallback; } catch(e){ return fallback; }
        },
        save(key, value){
            try { localStorage.setItem(key, JSON.stringify(value)); } catch(e){ console.warn("Save failed", e); }
        }
    };

    // Default structures
    let tasks = Store.load("tasks", []);
    let clientTasks = Store.load("clientTasks", {});
    let projects = Store.load("projects", []);
    let invoices = Store.load("invoices", []);
    let chatStore = Store.load("chatStore", {});
    let profile = Store.load("profile", { name: "Felix User", avatar: "https://api.dicebear.com/7.x/avataaars/svg?seed=Felix" });
    let mediaStore = Store.load("mediaStore", {});

    // Utilities to rebuild data from DOM
    function saveTasksFromDOM(){
        const arr = [];
        document.querySelectorAll('#task-list .task-text').forEach(el => arr.push(el.innerText.trim()));
        tasks = arr;
        Store.save("tasks", tasks);
    }
    function saveClientTasksFromDOM(name){
        if(!name) return;
        const arr = [];
        document.querySelectorAll('#client-task-list .task-text').forEach(el => arr.push(el.innerText.trim()));
        clientTasks[name] = arr;
        Store.save("clientTasks", clientTasks);
    }
    function saveInvoicesFromDOM(){
        const arr = [];
        document.querySelectorAll('#invoice-table-body tr').forEach(tr => {
            const tds = tr.querySelectorAll('td');
            if(tds.length < 4) return;
            const id = tds[0].innerText.trim();
            const client = tds[1].innerText.trim();
            const date = tds[2].innerText.trim();
            const amount = tds[3].innerText.trim().replace(/[^0-9.-]/g,'');
            const statusBtn = tr.querySelector('button');
            const status = statusBtn ? statusBtn.innerText.trim() : '';
            const linkEl = tr.querySelector('a');
            const link = linkEl ? linkEl.href : '';
            arr.push({id, client, date, amount, status, link});
        });
        invoices = arr;
        Store.save("invoices", invoices);
    }
    function saveProjectsFromMemory(){ Store.save("projects", projects); }
    function saveChatStore(){ Store.save("chatStore", chatStore); }
    function saveProfile(){ Store.save("profile", profile); }
    function saveMediaStore(){ Store.save("mediaStore", mediaStore); }

    // --- Wrappers: intercept actions and save after original behavior ---
    function wrap(name, saver){
        if(typeof window[name] !== 'function') return;
        const orig = window[name];
        window[name] = function(...args){
            const res = orig.apply(this, args);
            try { saver(...args); } catch(e){ console.warn("Saver failed", name, e); }
            return res;
        };
    }

    // Wrap addTask: after original runs, save tasks from DOM
    wrap('addTask', function(){ saveTasksFromDOM(); });
    // Wrap edit and delete actions use event handlers in DOM; add a MutationObserver to save on changes
    // Wrap client task add
    wrap('addClientTask', function(){ if(window.activeClientName) saveClientTasksFromDOM(window.activeClientName); });
    // Wrap invoice creation
    wrap('handleCreateInvoice', function(){ saveInvoicesFromDOM(); });
    // Wrap project save
    wrap('handleSaveProject', function(){ saveProjectsFromMemory(); renderSavedProjects(); });
    // Wrap chat senders
    wrap('sendChatMessage', function(){ if(window.activeClientName) { chatStore[window.activeClientName] = chatStore[window.activeClientName] || []; /* last messages already pushed by original */ Store.save("chatStore", chatStore); } });
    wrap('sendGlobalMessage', function(){ Store.save("chatStore", chatStore); });
    // Wrap profile update and image upload
    wrap('handleUpdateProfile', function(){ const newName = document.getElementById('setting-name')?.value; if(newName) profile.name = newName; profile.avatar = document.getElementById('setting-avatar')?.src || profile.avatar; saveProfile(); renderProfile(); });
    wrap('handleProfileImage', function(input){ // the original updates src; mirror it into profile
        const el = document.getElementById('setting-avatar');
        if(el && el.src) profile.avatar = el.src;
        saveProfile();
        renderProfile();
    });
    // Wrap addMedia to capture added media item(s)
    wrap('addMedia', function(){
        // after addMedia runs, grab last image in media-grid
        const imgs = document.querySelectorAll('#media-grid img');
        if(imgs.length){
            const last = imgs[imgs.length-1];
            const src = last.src;
            if(window.activeClientName){
                mediaStore[window.activeClientName] = mediaStore[window.activeClientName] || [];
                mediaStore[window.activeClientName].push(src);
                saveMediaStore();
            }
        }
    });

    // MutationObserver to watch task list and invoice table changes (for edits/deletes)
    const observer = new MutationObserver(function(){
        saveTasksFromDOM();
        saveInvoicesFromDOM();
        if(window.activeClientName) saveClientTasksFromDOM(window.activeClientName);
    });
    const taskList = document.getElementById('task-list');
    if(taskList) observer.observe(taskList, { childList:true, subtree:true, characterData:true });

    const invoiceBody = document.getElementById('invoice-table-body');
    if(invoiceBody) observer.observe(invoiceBody, { childList:true, subtree:true, characterData:true });

    const clientTaskList = document.getElementById('client-task-list');
    if(clientTaskList) observer.observe(clientTaskList, { childList:true, subtree:true, characterData:true });

    // --- Rendering helpers to load saved data into DOM ---
    function renderTasks(){
        const list = document.getElementById('task-list');
        if(!list) return;
        list.innerHTML = '';
        if(tasks.length === 0){
            // keep empty state if exists
        }
        tasks.forEach(t => list.appendChild(createTaskHTML(t)));
        // Recreate icons
        if(window.lucide && lucide.createIcons) lucide.createIcons();
    }

    function renderClientTasks(name){
        const list = document.getElementById('client-task-list');
        if(!list) return;
        list.innerHTML = '';
        const arr = clientTasks[name] || [];
        if(arr.length === 0){
            list.innerHTML = '<li class="p-8 text-center text-sm text-slate-400 italic" id="client-task-empty">No tasks specific to this client yet.</li>';
            return;
        }
        arr.forEach(t => list.appendChild(createTaskHTML(t)));
        if(window.lucide && lucide.createIcons) lucide.createIcons();
    }

    function renderSavedProjects(){
        const grid = document.getElementById('clients-grid');
        if(!grid) return;
        // Build minimal Add New button HTML (kept from original)
        const addButtonHTML = `<button onclick="openModal('modal-project')" class="group border border-dashed border-slate-300 rounded-xl p-6 flex flex-col items-center justify-center gap-3 hover:border-blue-400 hover:bg-blue-50/50 transition-all h-full min-h-[200px]">
                    <div class="w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center group-hover:bg-blue-100 transition-colors">
                        <i data-lucide="plus" class="w-5 h-5 text-slate-400 group-hover:text-blue-600"></i>
                    </div>
                    <span class="text-sm font-medium text-slate-500 group-hover:text-blue-600">New Client</span>
                </button>`;
        grid.innerHTML = '';
        projects.forEach(p => {
            const div = document.createElement('div');
            div.className = "group bg-white rounded-xl p-6 cursor-pointer border border-slate-100 shadow-[0_2px_10px_-4px_rgba(0,0,0,0.05)] hover:shadow-lg hover:-translate-y-1 transition-all duration-300 relative overflow-hidden";
            div.onclick = function(){ openClientDetail(p.name, p.name, p.desc); };
            const i1 = (p.name || 'X').charAt(0);
            div.innerHTML = `<div class="absolute left-0 top-0 bottom-0 w-1 bg-blue-500"></div>
                    <div class="flex justify-between items-start mb-4"><h3 class="text-lg font-semibold text-slate-900">${p.name}</h3><div class="px-2 py-1 bg-green-50 text-green-600 rounded text-[10px] font-semibold border border-green-100">Active</div></div>
                    <p class="text-sm text-slate-400 leading-relaxed mb-8 line-clamp-2">${p.desc}</p>
                    <div class="flex items-center justify-between pt-4 border-t border-slate-50">
                        <div class="flex -space-x-2">
                             <div class="w-7 h-7 rounded-full border-2 border-white bg-gradient-to-br from-blue-400 to-indigo-500 flex items-center justify-center text-[9px] text-white font-bold">${i1}</div>
                             <div class="w-7 h-7 rounded-full border-2 border-white bg-slate-100 flex items-center justify-center text-[9px] text-blue-600 font-bold">+1</div>
                        </div>
                        <span class="text-xs font-medium text-slate-400">Saved</span>
                    </div>`;
            grid.appendChild(div);
        });
        // append add button
        const wrap = document.createElement('div');
        wrap.innerHTML = addButtonHTML;
        grid.appendChild(wrap.firstElementChild);
        if(window.lucide && lucide.createIcons) lucide.createIcons();
    }

    function renderInvoices(){
        const tbody = document.getElementById('invoice-table-body');
        if(!tbody) return;
        tbody.innerHTML = '';
        invoices.forEach(inv => {
            const tr = document.createElement('tr');
            tr.className = "hover:bg-slate-50/80 transition-colors";
            const linkHtml = inv.link ? `<a href="${inv.link}" target="_blank" class="text-slate-400 hover:text-blue-600 inline-block p-1"><i data-lucide="external-link" class="w-4 h-4"></i></a>` : `<span class="text-slate-200 cursor-not-allowed p-1"><i data-lucide="external-link" class="w-4 h-4"></i></span>`;
            tr.innerHTML = `<td class="px-6 py-4 font-medium text-slate-900">${inv.id}</td>
                <td class="px-6 py-4 text-slate-600">${inv.client}</td>
                <td class="px-6 py-4 text-slate-500 text-xs">${inv.date}</td>
                <td class="px-6 py-4 font-medium text-slate-900">$${inv.amount}</td>
                <td class="px-6 py-4"><button onclick="toggleInvoiceStatus(this)" class="status-${inv.status.toLowerCase()} px-2 py-1 rounded-full text-[10px] border font-medium transition-all hover:opacity-80">${inv.status}</button></td>
                <td class="px-6 py-4 text-right">${linkHtml}</td>`;
            tbody.appendChild(tr);
        });
        if(window.lucide && lucide.createIcons) lucide.createIcons();
    }

    function renderProfile(){
        const nameEl = document.getElementById('header-username');
        const avatarEl = document.getElementById('header-avatar');
        const settingAvatar = document.getElementById('setting-avatar');
        if(nameEl) nameEl.innerText = profile.name || '';
        if(avatarEl) avatarEl.src = profile.avatar || avatarEl.src;
        if(settingAvatar) settingAvatar.src = profile.avatar || settingAvatar.src;
    }

    function renderMediaForClient(name){
        const grid = document.getElementById('media-grid');
        if(!grid) return;
        grid.innerHTML = '';
        const arr = mediaStore[name] || [];
        if(arr.length === 0){
            // leave empty state or placeholder
            grid.innerHTML = '';
            return;
        }
        arr.forEach(src => {
            const div = document.createElement('div');
            div.className = "group relative aspect-square bg-slate-100 rounded-xl overflow-hidden border border-slate-200";
            div.innerHTML = `<img src="${src}" class="w-full h-full object-cover opacity-80 group-hover:opacity-100 transition-opacity">
                <button onclick="this.parentElement.remove(); saveMediaAfterRemove('${name}','${src}')" class="absolute top-2 right-2 bg-white/90 p-1.5 rounded-md text-red-500 opacity-0 group-hover:opacity-100 transition-opacity hover:bg-white"><i data-lucide="trash-2" class="w-3.5 h-3.5"></i></button>`;
            grid.appendChild(div);
        });
        if(window.lucide && lucide.createIcons) lucide.createIcons();
    }

    window.saveMediaAfterRemove = function(name, src){
        if(!mediaStore[name]) return;
        mediaStore[name] = mediaStore[name].filter(s => s !== src);
        saveMediaStore();
    };

    // --- On load: render everything from storage ---
    document.addEventListener('DOMContentLoaded', function(){
        // Render profile
        renderProfile();
        // Render tasks
        renderTasks();
        // Render projects
        renderSavedProjects();
        // Render invoices
        renderInvoices();
        // Render chat sidebar if view-chat exists
        if(typeof renderChatSidebar === 'function') renderChatSidebar();
        // If a client is open, render its tasks & media
        if(window.activeClientName){
            renderClientTasks(window.activeClientName);
            renderMediaForClient(window.activeClientName);
            if(typeof initChat === 'function') initChat(window.activeClientName);
        }
    });

    // Also save periodically as a fallback
    setInterval(function(){
        Store.save("tasks", tasks);
        Store.save("clientTasks", clientTasks);
        Store.save("projects", projects);
        Store.save("invoices", invoices);
        Store.save("chatStore", chatStore);
        Store.save("profile", profile);
        Store.save("mediaStore", mediaStore);
    }, 2000);

    // Expose for debugging
    window.__PERSISTENCE = { Store, tasks, clientTasks, projects, invoices, chatStore, profile, mediaStore, renderSavedProjects };

})();
</script>
<!-- END PERSISTENCE -->

</body></html>
